<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Baccarat Tracker</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
        }
        label {
            margin-right: 15px;
        }
        #prediction, #pnl, #history, #tie-stats {
            margin-top: 20px;
            font-size: 18px;
        }
        #pnl {
            color: darkgreen;
            font-weight: bold;
        }
        #history {
            font-size: 14px;
            margin-top: 10px;
        }
        .tie {
            color: darkorange;
        }
    </style>
</head>
<body>

    <h2>Ввод результата раунда</h2>
    <button onclick="addResult('Игрок')">Игрок</button>
    <button onclick="addResult('Банкир')">Банкир</button>
    <button onclick="addResult('Ничья')">Ничья</button><br><br>

    <label><input type="checkbox" id="ppCheckbox"> Player Pair</label>
    <label><input type="checkbox" id="bpCheckbox"> Banker Pair</label>

    <div id="prediction">Ожидание ввода...</div>
    <div id="pnl">PNL: 0</div>
    <div id="tie-stats"></div>
    <div id="history"></div>

    <script>
    let shoe = [];
    let pnl = 0;
    let betHistory = [];

    function addResult(result) {
        let val;
        const pp = document.getElementById('ppCheckbox').checked;
        const bp = document.getElementById('bpCheckbox').checked;

        if (result === 'Игрок') val = pp ? 3 : 0;
        else if (result === 'Банкир') val = bp ? 4 : 1;
        else if (result === 'Ничья') val = 2;

        shoe.push(val);

        // сохранить чекбокс-состояния
        const currentPP = pp;
        const currentBP = bp;

        // сбросить чекбоксы
        document.getElementById('ppCheckbox').checked = false;
        document.getElementById('bpCheckbox').checked = false;

        updateBet(currentPP, currentBP);
    }

    function updateBet(ppBet, bpBet) {
        fetch('/get_bet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ shoe })
        })
        .then(r => r.json())
        .then(data => {
            const predictionText = data.stats.pair_prediction_result;
            document.getElementById('prediction').innerText = `Прогноз: ${predictionText}`;

            // расчет PNL по последнему ходу
            const lastVal = shoe[shoe.length - 1];
            let lastPnl = 0;

            if (ppBet && predictionText.includes("Player Pair")) {
                if (lastVal === 3) lastPnl += 11; // win
                else lastPnl -= 1; // loss
            }
            if (bpBet && predictionText.includes("Banker Pair")) {
                if (lastVal === 4) lastPnl += 11;
                else lastPnl -= 1;
            }

            pnl += lastPnl;
            document.getElementById('pnl').innerText = `PNL: ${pnl}`;

            // история
            betHistory.push({
                round: shoe.length,
                result: lastVal,
                pp: ppBet,
                bp: bpBet,
                pnl: lastPnl,
                prediction: predictionText
            });
            updateHistory();
            updateTieStats();
        });
    }

    function updateHistory() {
        let html = "<h3>История ставок:</h3><ul>";
        for (let entry of betHistory) {
            let resText = entry.result === 0 ? "Игрок" :
                          entry.result === 1 ? "Банкир" :
                          entry.result === 2 ? "<span class='tie'>Ничья</span>" :
                          entry.result === 3 ? "Игрок+Пара" :
                          "Банкир+Пара";
            html += `<li>Раунд ${entry.round}: ${resText}, Прогноз: ${entry.prediction}, Прибыль: ${entry.pnl}</li>`;
        }
        html += "</ul>";
        document.getElementById('history').innerHTML = html;
    }

    function updateTieStats() {
        const tieIndexes = shoe
            .map((v, i) => v === 2 ? i + 1 : null)
            .filter(i => i !== null);
        if (tieIndexes.length > 0) {
            document.getElementById('tie-stats').innerHTML =
                `Ничьи выпали в раундах: ${tieIndexes.join(', ')}`;
        } else {
            document.getElementById('tie-stats').innerText = '';
        }
    }
    </script>

</body>
</html>
